<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- åŸºæœ¬ SEO -->
  <meta charset="UTF-8">
  <meta name="description" content="ğŸ™ï¸ ç›´æ’­æ™‚é–“è»¸å°å¹«æ‰‹ â€” å¿«é€Ÿæ¨™è¨˜ YouTube ç›´æ’­æ­Œæ›²æ™‚é–“æˆ³ï¼Œä¸€éµç”¢ç”Ÿç« ç¯€æ™‚é–“è»¸ï¼">
  <!-- Open Graph (Facebook / LINE / Discord / Telegram éƒ½æœƒç”¨) -->
  <meta property="og:title" content="ç›´æ’­æ™‚é–“è»¸å°å¹«æ‰‹">
  <meta property="og:description" content="å¿«é€Ÿæ¨™è¨˜ YouTube ç›´æ’­æ­Œæ›²æ™‚é–“æˆ³ï¼Œä¸€éµç”¢ç”Ÿç« ç¯€æ™‚é–“è»¸ï¼æ”¯æ´å¤šå·¥ä½œè¡¨ã€æ­Œæ›²å»ºè­°ã€è·¨æ—¥è¨ˆç®—ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://lumus-lab.github.io/livestream-timeline/">
  <meta property="og:image" content="https://lumus-lab.github.io/livestream-timeline/assets/preview.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ç›´æ’­æ™‚é–“è»¸å°å¹«æ‰‹">
  <meta name="twitter:description" content="å¿«é€Ÿæ¨™è¨˜ YouTube ç›´æ’­æ­Œæ›²æ™‚é–“æˆ³ï¼Œä¸€éµç”¢ç”Ÿç« ç¯€æ™‚é–“è»¸ï¼æ”¯æ´å¤šå·¥ä½œè¡¨ã€æ­Œæ›²å»ºè­°ã€è·¨æ—¥è¨ˆç®—ã€‚">
  <meta name="twitter:image" content="https://lumus-lab.github.io/livestream-timeline/assets/preview.png">
  <title>ç›´æ’­æ™‚é–“è»¸å°å¹«æ‰‹</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em 15%;
      line-height: 1.6;
      background-color: #fff;
      color: #111;
    }

    label {
      display: block;
      margin-top: 1em;
    }

    .time-row {
      display: flex;
      gap: 0.5em;
      align-items: center;
      margin-bottom: 0.5em;
    }

    .time-row input {
      font-size: 16px;
    }

    .floating-clock {
      position: fixed;
      top: 35px;
      right: 1em;
      background-color: #eee;
      color: #111;
      padding: 0.5em 1em;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      border: 1px solid #bbb; /* â† æ˜ç¢ºé‚Šæ¡† */
      font-family: monospace; /* âœ… ç­‰å¯¬å­—é«” */
      text-align: center; /* âœ… æ–‡å­—ç½®ä¸­ */
    }

    button {
      margin-top: 1em;
      padding: 0.4em 0.8em;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #bbb;
      background-color: #eee;
      color: #111;
      border-radius: 4px;
    }

    textarea.readonly-output {
      background: #f2f2f2;
      padding: 0.5em;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      resize: none;
      overflow: hidden;
      height: auto;
      box-sizing: border-box;
    }

    .song-row {
      display: flex;
      gap: 0.5em;
      margin-bottom: 0.5em;
      position: relative; /* <--- åŠ ä¸Šé€™ä¸€è¡Œ */
    }

    .song-row input {
      height: 44px;
      box-sizing: border-box;
      font-size: 16px;
      white-space: normal;
      word-wrap: break-word;
    }

    .intro, .time-block, .result-block, .adjust-block {
      margin-bottom: 2em;
      background-color: #f9f9f9;
      padding: 1.5em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .intro h2 {
      margin-top: 0;
    }

    .intro-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 2em;
    }

    .intro-column {
      flex: 1;
      min-width: 250px;
    }

    .ps-note {
      font-size: 0.9em;
      font-style: italic;
      color: #666;
    }

    #adjustArea {
      font-size: 16px;
      width: 100%;
      resize: none;
      overflow: hidden;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0.5em;
      box-sizing: border-box;
    }

    /* å»ºè­°åˆ—è¡¨ */
    .suggest-list {
      position: absolute;
      background: #333;       /* èƒŒæ™¯é¡è‰²ï¼ˆå¯èª¿æ•´ï¼‰ */
      color: #fff;            /* æ–‡å­—é¡è‰² */
      border: 1px solid #555; /* é‚Šæ¡† */
      border-radius: 4px;
      margin-top: 2px;
      list-style: none;
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;            /* èˆ‡è¼¸å…¥æ¡†å¯¬åº¦ä¸€è‡´ */
      box-sizing: border-box;
      margin: 0;
    }

    .suggest-list li {
      padding: 6px 10px;
      cursor: pointer;
    }

    .suggest-list li:hover {
      background: #555;
    }

    .hidden {
      display: none;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #555;
      color: #fff;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      max-width: 300px;
      z-index: 1000;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 1em;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    #clearFixedContainer {
      position: fixed;
      bottom: 1em;
      right: 1em;
      z-index: 9999;
    }

    #clearFixedContainer button {
      background-color: #e53935;
      color: white;
      padding: 0.5em 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .sheet-tab-btn {
      display: block;
      margin-bottom: 0.5em;
      padding: 0.6em 1em;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 140px;
      text-align: left;
    }

    .sheet-tab-btn.active {
      outline: 3px solid black;
      box-shadow: 0 0 0 2px white;
    }

    .sheet-tab-btn-wrapper {
      width: 140px;
    }

    #sheetTabsContainer {
      position: fixed;
      top: 1em;
      left: 1em;
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }

    .sheet-tab-menu {
      position: absolute;
      right: 0.5em;
      top: 0.3em;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
      user-select: none;
    }

    /* å½ˆå‡ºçš„é¸å–® */
    .sheet-menu-popup {
      position: absolute;
      top: 2em;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 14px;
      z-index: 1002;
      overflow: hidden;
    }

    .sheet-menu-popup div {
      padding: 0.5em 1em;
      cursor: pointer;
      white-space: nowrap;
    }

    .sheet-menu-popup div:hover {
      background: #eee;
    }

    /* æ·±è‰²æ¨¡å¼ */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #111;
        color: #eee;
      }
      .intro, .time-block, .result-block, .adjust-block, textarea.readonly-output {
        background-color: #222;
        color: #ddd;
        border: 1px solid #444;
      }
      input, textarea {
        background-color: #333;
        color: #fff;
        border: 1px solid #555;
      }
      button {
        background-color: #444;
        color: #fff;
        border: 1px solid #666;
      }
      .ps-note {
        color: #aaa;
      }
      .modal {
        background: #fff;
        color: #555;
      }
      .suggest-list {
        background: #333;
        color: #fff;
        border: 1px solid #555;
      }
      .suggest-list li:hover {
        background-color: #555;
      }
      .sheet-menu-popup {
        background: #333;
        border-color: #555;
        color: #eee;
      }
      .sheet-menu-popup div:hover {
        background: #444;
      }
      .sheet-tab-btn.active {
        outline: 3px solid white;
        box-shadow: 0 0 0 2px black;
      }
      .floating-clock {
        background-color: #333;
        color: white;
        border: 1px solid #666;
      }
    }
  </style>
</head>
<body>
  <!-- ğŸ“Œ å·¦ä¸Šè§’åˆ†é èˆ‡æ–°å¢æŒ‰éˆ•å€å¡Š -->
  <div id="sheetTabsContainer">
    <button onclick="createNewSheet()" class="sheet-tab-add-btn">âœš æ–°å¢å·¥ä½œè¡¨</button>
    <!-- æ‰€æœ‰å·¥ä½œè¡¨æŒ‰éˆ•æœƒç”± JS å‹•æ…‹æ’å…¥åœ¨é€™è£¡ -->
  </div>

  <div class="intro">
    <h1>ğŸ™ï¸ ç›´æ’­æ™‚é–“è»¸å°å¹«æ‰‹</h1>
    <p>é€™æ˜¯ä¸€å€‹ç”¨ä¾†å¿«é€Ÿæ¨™è¨˜ YouTube ç›´æ’­æ­Œæ›²æ™‚é–“æˆ³çš„å°å·¥å…·ã€‚<br>
    å¡«å…¥ç›´æ’­é–‹å§‹æ™‚é–“ã€çµæŸæ™‚é–“ã€ç›´æ’­æ™‚é•·ã€æ­Œæ›²æ¸…å–®ï¼Œå³å¯ä¸€éµç”¢ç”Ÿç« ç¯€æ™‚é–“è»¸ï¼<br>
    <span class="ps-note">p.s. ä¹Ÿå¯ä»¥ç”¨ä¾†æ¨™è¨˜ç²¾è¯ï¼ˆshortsï¼‰æ™‚é–“é»å–”ï¼</span>
    </p>

    <div class="intro-columns">
      <div class="intro-column">
        <h2>âœ¨ åŠŸèƒ½ç‰¹è‰²</h2>
        <ol>
          <li>æ”¯æ´ã€Œå¤šåˆ†é å·¥ä½œè¡¨ã€ç®¡ç†ï¼Œä¸åŒæ­Œå–®äº’ä¸å¹²æ“¾</li>
          <li>åˆ†é å¯å‘½åã€åˆ‡æ›ã€åˆªé™¤ï¼Œé¡è‰²è‡ªå‹•åˆ†é…é¿å…æ··æ·†</li>
          <li>æ‰€æœ‰è³‡æ–™æœƒè‡ªå‹•å„²å­˜åœ¨ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸æ€•åˆ·æ–°</li>
          <li>è‡ªå‹•é‚„åŸä¸Šæ¬¡å¡«å¯«å…§å®¹ï¼Œåˆ‡æ›åˆ†é å³åˆ‡æ›å°æ‡‰è³‡æ–™</li>
          <li>å³æ™‚é¡¯ç¤ºæœ¬åœ°æ™‚é–“ï¼Œå¯ä¸€éµå¡«å…¥ç›®å‰æ™‚é–“</li>
          <li>æ­Œå + æ™‚é–“åˆ†é–‹è¼¸å…¥ï¼Œå¯è‡ªç”±æ–°å¢æˆ–åˆªé™¤æ¬„ä½</li>
          <li>æ­Œæ›²å»ºè­°åŠŸèƒ½ï¼Œå¯å¾é€£æ¥çš„è‡ªå»ºæ­Œæ›²è³‡æ–™åº«ä¸­æœå°‹å·²å»ºæª”æ­Œæ›²</li>
          <li>è‡ªå‹•è·¨æ—¥è¨ˆç®—ï¼ˆå¦‚ 23:00 â†’ 01:00ï¼‰è™•ç†ç„¡èª¤</li>
          <li>ç”¢ç”Ÿç« ç¯€æ™‚é–“è»¸æ™‚ï¼Œæœƒæ ¹æ“šæ™‚é–“è‡ªå‹•æ’åºè¼¸å‡º</li>
          <li>ã€Œæ ¡æ­£å€ã€å¯æ‰‹å‹•ç·¨è¼¯ç« ç¯€ï¼Œè¼¸å‡ºæ ¼å¼å¯ç›´æ¥è²¼åˆ° YouTube</li>
          <li>æä¾›ã€ŒğŸ”„ å›å¾©æˆé è¨­ã€æŒ‰éˆ•å¯å¿«é€Ÿé‡ç½®æ‰€æœ‰å…§å®¹</li>
        </ol>
      </div>
      <div class="intro-column">
        <h2>ğŸ“– ä½¿ç”¨æ–¹å¼æ•™å­¸</h2>
        <ol>
          <li>å¯æ–°å¢å¤šå€‹åˆ†é ï¼Œæ¯å€‹åˆ†é å°æ‡‰ä¸€ä»½ç¨ç«‹æ­Œå–®</li>
          <li>æ¯é å¯è¨­å®šé–‹å°æ™‚é–“ã€é—œå°æ™‚é–“ã€ç›´æ’­æ™‚é•·ã€æ­Œæ›²æ¸…å–®</li>
          <li>æ­Œæ›²æ¸…å–®ä¸­å¡«å…¥ã€Œæ­Œå + æ™‚é–“ã€ï¼Œå¯æŒ‰ä¸‹ã€Œç¾åœ¨æ™‚é–“ã€å¿«é€Ÿå¡«å…¥</li>
          <li>å¦‚è¦åˆªé™¤æ­Œå–®åˆ—ï¼Œå¯é»é¸ã€Œåˆªé™¤ã€æŒ‰éˆ•ï¼Œæœƒè·³å‡ºç¢ºèªæé†’</li>
          <li>å¯é¸æ“‡å•Ÿç”¨ã€Œæ­Œæ›²å»ºè­°ã€åŠŸèƒ½ï¼Œå¾æ­Œæ›²è³‡æ–™åº«è‡ªå‹•æœå°‹</li>
          <li>æŒ‰ä¸‹ã€Œâœ… ç”¢ç”Ÿç›´æ’­æ™‚é–“è»¸ã€å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•ä¾ç…§æ™‚é–“æ’åºè¼¸å‡ºçµæœ</li>
          <li>å¦‚æœ‰éœ€è¦å¾®èª¿æ™‚é–“æˆ–æ ¼å¼ï¼Œå¯åˆ°ã€Œæ ¡æ­£å€ã€æ‰‹å‹•ä¿®æ”¹</li>
          <li>é»æ“Šã€ŒğŸ”„ å›å¾©æˆé è¨­ã€å¯æ¸…é™¤æ‰€æœ‰å·¥ä½œè¡¨èˆ‡è³‡æ–™ï¼Œé‡è¨­ç‚ºç©ºç™½ç‹€æ…‹</li>
        </ol>
      </div>
    </div>
    <div style="text-align: center; color: #ecbc00; font-size: 0.95em; margin-top: 2em; font-weight: bold;">
      ğŸ” æœ¬å·¥å…·æ‰€æœ‰è¼¸å…¥çš„è³‡æ–™å‡å„²å­˜åœ¨ã€Œæ‚¨è‡ªå·±çš„ç€è¦½å™¨ã€ä¸­ï¼Œé€é localStorage æŠ€è¡“è‡ªå‹•ä¿å­˜ï¼Œä¸éœ€è¦æ‰‹å‹•å‚™ä»½<br>
      ğŸ’¡ æœ¬å·¥å…·ç‚ºç´”å‰ç«¯é‹ä½œï¼Œæ‚¨å¡«å¯«çš„ä»»ä½•å…§å®¹ã€Œéƒ½ä¸æœƒè¢«ä¸Šå‚³è‡³ä¼ºæœå™¨ã€<br>
      æ‰€æœ‰è³‡æ–™çš†åƒ…å­˜åœ¨æ–¼æ‚¨çš„è£ç½®ä¸­ï¼Œé–‹ç™¼è€…ç„¡æ³•å­˜å–ã€æŸ¥çœ‹æˆ–å‚™ä»½æ‚¨æ‰€è¼¸å…¥çš„è³‡æ–™ã€‚è«‹æ”¾å¿ƒä½¿ç”¨
    </div>    
  </div>

  <div class="floating-clock" id="clock"></div>

  <div class="time-block">
    <div class="time-row">
      <label>é–‹å°æ™‚é–“ (Start Time):
        <input type="text" id="startTime" placeholder="HH:MM:SS">
        <button onclick="fillNow('startTime')">ç¾åœ¨æ™‚é–“</button>
      </label>
    </div>

    <div class="time-row">
      <label>é—œå°æ™‚é–“ (End Time):
        <input type="text" id="endTime" placeholder="HH:MM:SS">
        <button onclick="fillNow('endTime')">ç¾åœ¨æ™‚é–“</button>
      </label>
    </div>

    <div class="time-row">
      <label>ç›´æ’­æ™‚é•· (Duration):
        <input type="text" id="duration" placeholder="HH:MM:SS">
      </label>
    </div>

    <div style="display: flex; align-items: center; gap: 10px;">
      <label>æ­Œæ›²æ¸…å–®ï¼ˆæ­Œå + æ™‚é–“ï¼‰</label>
      <label style="font-size:14px; cursor:pointer;">
        <input type="checkbox" id="toggleSuggest">
        å•Ÿç”¨æ­Œæ›²å»ºè­°
      </label>
    </div>

    <div id="songList"></div>
    <button onclick="addSongRow()">ğŸˆ³ æ–°å¢æ­Œæ›²æ¬„ä½</button>

    <button onclick="generateTimeline()">âœ… ç”¢ç”Ÿç›´æ’­æ™‚é–“è»¸</button>
  </div>

  <div class="result-block">
    <h3>ğŸ“‹ çµæœ</h3>
    <textarea class="readonly-output" id="output" readonly></textarea>
  </div>

  <div class="adjust-block">
    <h3>âœï¸ æ ¡æ­£å€</h3>
    <textarea id="adjustArea" placeholder="åœ¨é€™è£¡è²¼ä¸Šä¸¦æ ¡æ­£æ™‚é–“è»¸..." style="height:150px;"></textarea>
  </div>

  <div id="clearFixedContainer">
    <button onclick="clearAllData()">ğŸ”„ å›å¾©æˆé è¨­</button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="modal" id="confirmModal">
    <p>åˆªé™¤æ­¤æ¬„ä½æœƒæ¸…é™¤å…¶ä¸­å…§å®¹ï¼Œç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</p>
    <label><input type="checkbox" id="noRemind"> ä¸å†æé†’</label>
    <div class="modal-footer">
      <div></div>
      <button onclick="confirmDelete()">ç¢ºèª</button>
    </div>
  </div>

  <script>
    const colorOptions = [
      "#f44336", "#e91e63", "#9c27b0", "#3f51b5", "#03a9f4",
      "#009688", "#4caf50", "#ff9800", "#795548", "#607d8b"
    ];

    let timelineSheets = {
      currentSheet: "sheet1",
      sheets: {
        sheet1: {
          name: "å·¥ä½œè¡¨ 1",
          color: "#f44336",
          data: {
            startTime: "",
            endTime: "",
            duration: "",
            adjustArea: "",
            songs: []
          }
        }
      }
    };

    sessionStorage.removeItem('noRemind');
    let pendingDeleteRow = null;
    let songData = []; 
    let songLoadFailed = false; // ç”¨æ–¼æª¢æŸ¥ Google Sheets æ˜¯å¦è¼‰å…¥å¤±æ•—

    function showModal(row) {
      const inputs = row.querySelectorAll('input');
      const hasContent = Array.from(inputs).some(input => input.value.trim() !== '');
      const noRemind = sessionStorage.getItem('noRemind') === 'true';

      if (noRemind || !hasContent) {
        row.remove();
        saveAllData();
        return;
      }
      pendingDeleteRow = row;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('confirmModal').style.display = 'block';
    }

    function confirmDelete() {
      if (document.getElementById('noRemind').checked) {
        sessionStorage.setItem('noRemind', 'true');
      }
      if (pendingDeleteRow) {
        pendingDeleteRow.remove();
        saveAllData();
        pendingDeleteRow = null;
      }
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'none';
    }

    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById("clock").textContent = `â° ï¼š${h}:${m}:${s}`;
      const delay = 1000 - now.getMilliseconds();
      setTimeout(updateClock, delay);
    }
    updateClock();

    function fillNow(fieldId) {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById(fieldId).value = `${h}:${m}:${s}`;
      saveAllData();
    }

    function fillNowForSong(button) {
      // å¾€ä¸Šæ‰¾åˆ°æœ€è¿‘ä¸€å±¤çš„ .song-rowï¼ˆæ•´åˆ—ï¼‰
      const row = button.closest('.song-row');
    
      // åœ¨è©²åˆ—ä¸­æ‰¾ placeholder æ˜¯ã€Œæ™‚é–“ (HH:MM:SS)ã€çš„è¼¸å…¥æ¡†
      const timeInput = row.querySelector('input[placeholder="æ™‚é–“ (HH:MM:SS)"]');
    
      // å–å¾—ç¾åœ¨æ™‚é–“ä¸¦æ ¼å¼åŒ–æˆ HH:MM:SS
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
    
      // è‹¥æˆåŠŸæ‰¾åˆ°è©²æ¬„ä½ï¼Œå¡«å…¥æ™‚é–“ä¸¦å„²å­˜
      if (timeInput) {
        timeInput.value = `${h}:${m}:${s}`;
        saveAllData(); // åŒæ­¥å„²å­˜
      }
    }

    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    document.getElementById('adjustArea').addEventListener('input', function() {
      autoResizeTextarea(this);
      saveAllData();
    });

    document.getElementById('output').addEventListener('input', function() {
      autoResizeTextarea(this);
      saveAllData();
    });

    function normalizeTimeStr(t) {
      const parts = t.trim().split(":").map(Number);
      while (parts.length < 3) parts.push(0);
      return parts;
    }

    function toSeconds(t) {
      const [h, m, s] = normalizeTimeStr(t);
      return h * 3600 + m * 60 + s;
    }

    function formatSeconds(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // âœ… å°‡ç›®å‰ç•«é¢è³‡æ–™å³æ™‚å„²å­˜åˆ° timelineSheets çš„ç•¶å‰åˆ†é 
    function saveAllData() {
      const currentId = timelineSheets.currentSheet;
      const data = timelineSheets.sheets[currentId].data;

      data.startTime = document.getElementById('startTime').value;
      data.endTime = document.getElementById('endTime').value;
      data.duration = document.getElementById('duration').value;
      data.adjustArea = document.getElementById('adjustArea').value;
      data.songs = [];

      document.querySelectorAll('.song-row').forEach(row => {
        const inputs = row.querySelectorAll('input');
        data.songs.push({
          name: inputs[0].value,
          time: inputs[1].value
        });
      });

      localStorage.setItem('timelineSheets', JSON.stringify(timelineSheets));
    }

    // âœ… å°‡ timelineSheets çš„ç•¶å‰åˆ†é è³‡æ–™é‚„åŸè‡³ç•«é¢æ¬„ä½
    function restoreSheetData() {
      const currentId = timelineSheets.currentSheet;
      const data = timelineSheets.sheets[currentId].data;

      document.getElementById('startTime').value = data.startTime || '';
      document.getElementById('endTime').value = data.endTime || '';
      document.getElementById('duration').value = data.duration || '';
      document.getElementById('adjustArea').value = data.adjustArea || '';
      autoResizeTextarea(document.getElementById('adjustArea'));

      const container = document.getElementById('songList');
      container.innerHTML = '';

      // âœ… è‹¥è©²åˆ†é å®Œå…¨æ²’æ­Œæ›² â†’ é è¨­ç”¢å‡º 5 å€‹ç©ºç™½æ¬„ä½
      const songs = (data.songs && data.songs.length > 0) ? data.songs : Array(5).fill({ name: '', time: '' });
      songs.forEach(song => addSongRow(song.name, song.time));
    }


    // æ¸…ç©ºè³‡æ–™
    function clearAllData() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·¥ä½œè¡¨ï¼Œå›å¾©ç‚ºé è¨­ç‹€æ…‹ï¼Ÿ')) {
        // ç§»é™¤ timelineSheets è³‡æ–™
        localStorage.removeItem('timelineSheets');

        // å¦‚æœé‚„æ®˜ç•™èˆŠè³‡æ–™ä¹Ÿé †ä¾¿åˆªæ‰
        localStorage.removeItem('timelineData');

        // é‡æ–°è¼‰å…¥é é¢ï¼Œæœƒè‡ªå‹•å»ºç«‹é è¨­å·¥ä½œè¡¨
        location.reload();
      }
    }

    function renderSheetTabs() {
      const container = document.getElementById("sheetTabsContainer");

      // ğŸ” åªåˆªæ‰èˆŠçš„å·¥ä½œè¡¨æŒ‰éˆ•ï¼ˆ.sheet-tab-btnï¼‰ï¼Œä¿ç•™æ–°å¢æŒ‰éˆ•
      const oldButtons = container.querySelectorAll('.sheet-tab-btn-wrapper');
      oldButtons.forEach(btn => btn.remove());

      Object.entries(timelineSheets.sheets).forEach(([sheetId, sheet]) => {
        // åŒ…è£æ•´å€‹åˆ†é æŒ‰éˆ• + â‹¯ çš„ wrapper
        const wrapper = document.createElement("div");
        wrapper.className = "sheet-tab-btn-wrapper";
        wrapper.style.position = "relative";
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";

        // ğŸ”˜ åˆ†é æŒ‰éˆ•
        const btn = document.createElement("button");
        btn.className = "sheet-tab-btn";
        if (sheetId === timelineSheets.currentSheet) {
          btn.classList.add("active");
        }
        btn.textContent = sheet.name;
        btn.style.backgroundColor = sheet.color;
        btn.style.flex = "1";
        btn.onclick = () => {
          saveAllData();
          timelineSheets.currentSheet = sheetId;
          localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
          renderSheetTabs();
          restoreSheetData();
        };

        // â‹¯ æŒ‰éˆ•
        const moreBtn = document.createElement("div");
        moreBtn.textContent = "â‹¯";
        moreBtn.className = "sheet-tab-menu";
        moreBtn.onclick = (e) => {
          e.stopPropagation();
          showSheetMenu(sheetId, moreBtn);
        };

        wrapper.appendChild(btn);
        wrapper.appendChild(moreBtn);
        container.appendChild(wrapper);
      });
    }

    function createNewSheet() {
      // æ‰¾å‡ºæœªä½¿ç”¨çš„é¡è‰²
      const usedColors = Object.values(timelineSheets.sheets).map(sheet => sheet.color);
      let availableColors = colorOptions.filter(color => !usedColors.includes(color));
      if (availableColors.length === 0) {
        availableColors = [...colorOptions]; // å…¨éƒ¨ç”¨éå°±é‡ç½®
      }

      // éš¨æ©ŸæŒ‘ä¸€å€‹é¡è‰²
      const color = availableColors[Math.floor(Math.random() * availableColors.length)];

      // è‡ªå‹•å‘½åï¼šã€Œå·¥ä½œè¡¨ nã€
      const existingNames = Object.values(timelineSheets.sheets).map(s => s.name);
      let index = 1;
      let newName;
      do {
        newName = `å·¥ä½œè¡¨ ${index++}`;
      } while (existingNames.includes(newName));

      // è‡ªå‹•ç”¢ç”Ÿæ–° IDï¼ˆå¦‚ sheet3ã€sheet4ï¼‰
      let idCounter = 1;
      let newId;
      do {
        newId = `sheet${++idCounter}`;
      } while (timelineSheets.sheets[newId]);

      // æ–°å¢è³‡æ–™
      timelineSheets.sheets[newId] = {
        name: newName,
        color: color,
        data: {
          startTime: "",
          endTime: "",
          duration: "",
          adjustArea: "",
          songs: []
        }
      };

      timelineSheets.currentSheet = newId;
      localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
      renderSheetTabs();
      restoreSheetData();
    }

    function showSheetMenu(sheetId, anchorElement) {
      // å…ˆæ¸…é™¤èˆŠçš„ popupï¼ˆè‹¥å­˜åœ¨ï¼‰
      document.querySelectorAll(".sheet-menu-popup").forEach(el => el.remove());

      const menu = document.createElement("div");
      menu.className = "sheet-menu-popup";

      // âœï¸ é‡æ–°å‘½å
      const renameItem = document.createElement("div");
      renameItem.textContent = "âœï¸ é‡æ–°å‘½å";
      renameItem.onclick = () => {
        const newName = prompt("è«‹è¼¸å…¥æ–°çš„å·¥ä½œè¡¨åç¨±ï¼š", timelineSheets.sheets[sheetId].name);
        if (newName && newName.trim()) {
          timelineSheets.sheets[sheetId].name = newName.trim();
          localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
          renderSheetTabs();
        }
        menu.remove();
      };
      menu.appendChild(renameItem);

      // ğŸ—‘ï¸ åˆªé™¤åˆ†é 
      const deleteItem = document.createElement("div");
      deleteItem.textContent = "ğŸ—‘ï¸ åˆªé™¤å·¥ä½œè¡¨";
      deleteItem.onclick = () => {
        const sheetCount = Object.keys(timelineSheets.sheets).length;
        if (sheetCount <= 1) {
          alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å·¥ä½œè¡¨ï¼");
          return;
        }

        if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${timelineSheets.sheets[sheetId].name}ã€å—ï¼Ÿ\né€™å€‹å·¥ä½œè¡¨çš„æ‰€æœ‰è³‡æ–™å°‡ä¸€ä½µåˆªé™¤ã€‚`)) {
          delete timelineSheets.sheets[sheetId];

          // è‹¥åˆªé™¤çš„æ˜¯ç•¶å‰åˆ†é ï¼Œåˆ‡æ›åˆ°å…¶ä»–ä»»ä¸€å€‹
          if (timelineSheets.currentSheet === sheetId) {
            timelineSheets.currentSheet = Object.keys(timelineSheets.sheets)[0];
          }

          localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
          renderSheetTabs();
          restoreSheetData();
        }

        menu.remove();
      };
      menu.appendChild(deleteItem);

      // æ’å…¥é¸å–®
      anchorElement.parentElement.appendChild(menu);

      // é»å…¶ä»–åœ°æ–¹å°±é—œé–‰é¸å–®
      setTimeout(() => {
        window.addEventListener("click", () => menu.remove(), { once: true });
      }, 0);
    }

    function addSongRow(name = '', time = '') {
      const container = document.getElementById("songList");
      const row = document.createElement("div");
      row.className = "song-row";
      
      // --- è«‹å°‡ row.innerHTML å®Œå…¨æ›¿æ›æˆä»¥ä¸‹ç‰ˆæœ¬ ---
      row.innerHTML = `
        <button onclick="showModal(this.parentElement)">åˆªé™¤</button>

        <div style="position: relative; flex: 1;">
          <input 
            type="text" 
            placeholder="æ­Œå" 
            value="${name}" 
            oninput="saveAllData(); showSuggestions(this);" 
            onblur="setTimeout(() => { this.nextElementSibling.classList.add('hidden'); }, 150)"
            style="width: 100%;">
          <ul class="suggest-list hidden"></ul>
        </div>

        <div style="flex: 1;">
          <input 
            type="text" 
            placeholder="æ™‚é–“ (HH:MM:SS)" 
            value="${time}" 
            oninput="saveAllData()"
            style="width: 100%;">
        </div>

        <button onclick="fillNowForSong(this)">ç¾åœ¨æ™‚é–“</button>
      `;
      container.appendChild(row);
    }

    loadSongs(); // è®€å– Google Sheets è³‡æ–™

    // ç¶å®š startTime / endTime / duration
    ['startTime', 'endTime', 'duration'].forEach(id => {
      document.getElementById(id).addEventListener('input', saveAllData);
    });

    function generateTimeline() {
      let startTime = document.getElementById("startTime").value.trim();
      const endTime = document.getElementById("endTime").value.trim();
      const duration = document.getElementById("duration").value.trim();

      if (!startTime && endTime && duration) {
        let endSec = toSeconds(endTime);
        let durSec = toSeconds(duration);
        let startSec = endSec - durSec;
        if (startSec < 0) startSec += 86400;
        startTime = formatSeconds(startSec);
      }

      if (!startTime) {
        alert("è«‹è¼¸å…¥é–‹å°æ™‚é–“æˆ–æä¾›çµæŸæ™‚é–“èˆ‡æ™‚é•·ã€‚");
        return;
      }

      const startSec = toSeconds(startTime);
      let result = [];

      const rows = document.querySelectorAll(".song-row");
      for (const row of rows) {
        const inputs = row.querySelectorAll("input");
        const name = inputs[0].value.trim();
        const absTime = inputs[1].value.trim();
        if (!name || !absTime) continue;
        let songSec = toSeconds(absTime);
        let diff = songSec - startSec;
        if (diff < 0) diff += 86400; // è·¨æ—¥è™•ç†
        result.push({ time: diff, text: `${formatSeconds(diff)} ${name}` });
      }

      result.sort((a, b) => a.time - b.time);
      const outputEl = document.getElementById("output");
      outputEl.value = result.map(r => r.text).join("\n");
      autoResizeTextarea(outputEl);
      saveAllData();
    }

    // å¾ Google Sheets è¼‰å…¥è³‡æ–™
    function loadSongs() {
      const url = 'https://docs.google.com/spreadsheets/d/1fWMyrdJroo2bWngbxvdfLP6ohfGO87dSirEWbKzMVRE/export?format=csv'; // æ”¹æˆä½ çš„å…¬é–‹CSVé€£çµ
      fetch(url)
        .then(response => response.text())
        .then(data => {
          songData = data.split('\n').slice(1).map(line => {
            const [title, artist] = line.split(',');
            return `${title.trim()}ï¼ˆ${artist ? artist.trim() : ''}ï¼‰`;
          });
          songLoadFailed = false;
        })
        .catch(err => {
          songLoadFailed = true;
          console.error('Google Sheets è¼‰å…¥å¤±æ•—:', err);
        });
    }

    // å•Ÿç”¨å»ºè­°é–‹é—œæ™‚æª¢æŸ¥è¼‰å…¥ç‹€æ…‹
    document.getElementById('toggleSuggest').addEventListener('change', function() {
      if (this.checked && songLoadFailed) {
        alert('âš ï¸ æ­Œæ›²å»ºè­°è¼‰å…¥å¤±æ•—ï¼\nè«‹æª¢æŸ¥ä½ çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚');
      }
    });

    // é¡¯ç¤ºå»ºè­°
    function showSuggestions(input) {
      const list = input.nextElementSibling;
      if (!list || !list.classList.contains('suggest-list')) return;

      list.innerHTML = '';
      const query = input.value.trim().toLowerCase();

      if (!query || document.getElementById('toggleSuggest')?.checked === false) {
        list.classList.add('hidden');
        return;
      }

      const filtered = songData.filter(item => item.toLowerCase().includes(query));

      if (filtered.length === 0) {
        list.classList.add('hidden');
        return;
      }
      
      // é¡¯ç¤ºæ‰€æœ‰ç¬¦åˆçš„å»ºè­° (å·²ç§»é™¤ .slice(0, 5))
      filtered.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        li.onclick = () => {
          input.value = item;
          list.classList.add('hidden');
          saveAllData();
        };
        list.appendChild(li);
      });

      list.classList.remove('hidden');
    }

    initSheets(); // â† é é¢è¼‰å…¥æ™‚åŸ·è¡Œ

    function initSheets() {
      const saved = localStorage.getItem("timelineSheets");
      if (saved) {
        timelineSheets = JSON.parse(saved);
      } else {
        localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
      }

      renderSheetTabs();
      restoreSheetData(); // é€™å€‹ function ä¹‹å¾Œæœƒæ”¹ç‚ºè®€å–ã€Œç›®å‰åˆ†é ã€çš„è³‡æ–™
    }
  </script>
</body>
</html>
