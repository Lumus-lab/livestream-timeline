<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- 基本 SEO -->
  <meta charset="UTF-8">
  <meta name="description" content="🎙️ 直播時間軸小幫手 — 快速標記 YouTube 直播歌曲時間戳，一鍵產生章節時間軸！">
  <!-- Open Graph (Facebook / LINE / Discord / Telegram 都會用) -->
  <meta property="og:title" content="直播時間軸小幫手">
  <meta property="og:description" content="快速標記 YouTube 直播歌曲時間戳，一鍵產生章節時間軸！支援多工作表、歌曲建議、跨日計算。">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://lumus-lab.github.io/livestream-timeline/">
  <meta property="og:image" content="https://lumus-lab.github.io/livestream-timeline/assets/preview.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="直播時間軸小幫手">
  <meta name="twitter:description" content="快速標記 YouTube 直播歌曲時間戳，一鍵產生章節時間軸！支援多工作表、歌曲建議、跨日計算。">
  <meta name="twitter:image" content="https://lumus-lab.github.io/livestream-timeline/assets/preview.png">
  <title>直播時間軸小幫手</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em 15%;
      line-height: 1.6;
      background-color: #fff;
      color: #111;
    }

    label {
      display: block;
      margin-top: 1em;
    }

    .time-row {
      display: flex;
      gap: 0.5em;
      align-items: center;
      margin-bottom: 0.5em;
    }

    .time-row input {
      font-size: 16px;
    }

    .floating-clock {
      position: fixed;
      top: 35px;
      right: 1em;
      background-color: #eee;
      color: #111;
      padding: 0.5em 1em;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      border: 1px solid #bbb; /* ← 明確邊框 */
      font-family: monospace; /* ✅ 等寬字體 */
      text-align: center; /* ✅ 文字置中 */
    }

    button {
      margin-top: 1em;
      padding: 0.4em 0.8em;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #bbb;
      background-color: #eee;
      color: #111;
      border-radius: 4px;
    }

    textarea.readonly-output {
      background: #f2f2f2;
      padding: 0.5em;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      resize: none;
      overflow: hidden;
      height: auto;
      box-sizing: border-box;
    }

    .song-row {
      display: flex;
      gap: 0.5em;
      margin-bottom: 0.5em;
      position: relative; /* <--- 加上這一行 */
    }

    .song-row input {
      height: 44px;
      box-sizing: border-box;
      font-size: 16px;
      white-space: normal;
      word-wrap: break-word;
    }

    .intro, .time-block, .result-block, .adjust-block {
      margin-bottom: 2em;
      background-color: #f9f9f9;
      padding: 1.5em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .intro h2 {
      margin-top: 0;
    }

    .intro-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 2em;
    }

    .intro-column {
      flex: 1;
      min-width: 250px;
    }

    .ps-note {
      font-size: 0.9em;
      font-style: italic;
      color: #666;
    }

    #adjustArea {
      font-size: 16px;
      width: 100%;
      resize: none;
      overflow: hidden;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0.5em;
      box-sizing: border-box;
    }

    /* 建議列表 */
    .suggest-list {
      position: absolute;
      background: #333;       /* 背景顏色（可調整） */
      color: #fff;            /* 文字顏色 */
      border: 1px solid #555; /* 邊框 */
      border-radius: 4px;
      margin-top: 2px;
      list-style: none;
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;            /* 與輸入框寬度一致 */
      box-sizing: border-box;
      margin: 0;
    }

    .suggest-list li {
      padding: 6px 10px;
      cursor: pointer;
    }

    .suggest-list li:hover {
      background: #555;
    }

    .hidden {
      display: none;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #555;
      color: #fff;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      max-width: 300px;
      z-index: 1000;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 1em;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    #clearFixedContainer {
      position: fixed;
      bottom: 1em;
      right: 1em;
      z-index: 9999;
    }

    #clearFixedContainer button {
      background-color: #e53935;
      color: white;
      padding: 0.5em 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .sheet-tab-btn {
      display: block;
      margin-bottom: 0.5em;
      padding: 0.6em 1em;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 140px;
      text-align: left;
    }

    .sheet-tab-btn.active {
      outline: 3px solid black;
      box-shadow: 0 0 0 2px white;
    }

    .sheet-tab-btn-wrapper {
      width: 140px;
    }

    #sheetTabsContainer {
      position: fixed;
      top: 1em;
      left: 1em;
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }

    .sheet-tab-menu {
      position: absolute;
      right: 0.5em;
      top: 0.3em;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
      user-select: none;
    }

    /* 彈出的選單 */
    .sheet-menu-popup {
      position: absolute;
      top: 2em;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 14px;
      z-index: 1002;
      overflow: hidden;
    }

    .sheet-menu-popup div {
      padding: 0.5em 1em;
      cursor: pointer;
      white-space: nowrap;
    }

    .sheet-menu-popup div:hover {
      background: #eee;
    }

    /* 深色模式 */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #111;
        color: #eee;
      }
      .intro, .time-block, .result-block, .adjust-block, textarea.readonly-output {
        background-color: #222;
        color: #ddd;
        border: 1px solid #444;
      }
      input, textarea {
        background-color: #333;
        color: #fff;
        border: 1px solid #555;
      }
      button {
        background-color: #444;
        color: #fff;
        border: 1px solid #666;
      }
      .ps-note {
        color: #aaa;
      }
      .modal {
        background: #fff;
        color: #555;
      }
      .suggest-list {
        background: #333;
        color: #fff;
        border: 1px solid #555;
      }
      .suggest-list li:hover {
        background-color: #555;
      }
      .sheet-menu-popup {
        background: #333;
        border-color: #555;
        color: #eee;
      }
      .sheet-menu-popup div:hover {
        background: #444;
      }
      .sheet-tab-btn.active {
        outline: 3px solid white;
        box-shadow: 0 0 0 2px black;
      }
      .floating-clock {
        background-color: #333;
        color: white;
        border: 1px solid #666;
      }
    }
  </style>
</head>
<body>
  <!-- 📌 左上角分頁與新增按鈕區塊 -->
  <div id="sheetTabsContainer">
    <button onclick="createNewSheet()" class="sheet-tab-add-btn">✚ 新增工作表</button>
    <!-- 所有工作表按鈕會由 JS 動態插入在這裡 -->
  </div>

  <div class="intro">
    <h1>🎙️ 直播時間軸小幫手</h1>
    <p>這是一個用來快速標記 YouTube 直播歌曲時間戳的小工具。<br>
    填入直播開始時間、結束時間、直播時長、歌曲清單，即可一鍵產生章節時間軸！<br>
    <span class="ps-note">p.s. 也可以用來標記精華（shorts）時間點喔！</span>
    </p>

    <div class="intro-columns">
      <div class="intro-column">
        <h2>✨ 功能特色</h2>
        <ol>
          <li>支援「多分頁工作表」管理，不同歌單互不干擾</li>
          <li>分頁可命名、切換、刪除，顏色自動分配避免混淆</li>
          <li>所有資料會自動儲存在瀏覽器（localStorage），不怕刷新</li>
          <li>自動還原上次填寫內容，切換分頁即切換對應資料</li>
          <li>即時顯示本地時間，可一鍵填入目前時間</li>
          <li>歌名 + 時間分開輸入，可自由新增或刪除欄位</li>
          <li>歌曲建議功能，可從連接的自建歌曲資料庫中搜尋已建檔歌曲</li>
          <li>自動跨日計算（如 23:00 → 01:00）處理無誤</li>
          <li>產生章節時間軸時，會根據時間自動排序輸出</li>
          <li>「校正區」可手動編輯章節，輸出格式可直接貼到 YouTube</li>
          <li>提供「🔄 回復成預設」按鈕可快速重置所有內容</li>
        </ol>
      </div>
      <div class="intro-column">
        <h2>📖 使用方式教學</h2>
        <ol>
          <li>可新增多個分頁，每個分頁對應一份獨立歌單</li>
          <li>每頁可設定開台時間、關台時間、直播時長、歌曲清單</li>
          <li>歌曲清單中填入「歌名 + 時間」，可按下「現在時間」快速填入</li>
          <li>如要刪除歌單列，可點選「刪除」按鈕，會跳出確認提醒</li>
          <li>可選擇啟用「歌曲建議」功能，從歌曲資料庫自動搜尋</li>
          <li>按下「✅ 產生直播時間軸」後，系統會自動依照時間排序輸出結果</li>
          <li>如有需要微調時間或格式，可到「校正區」手動修改</li>
          <li>點擊「🔄 回復成預設」可清除所有工作表與資料，重設為空白狀態</li>
        </ol>
      </div>
    </div>
    <div style="text-align: center; color: #ecbc00; font-size: 0.95em; margin-top: 2em; font-weight: bold;">
      🔐 本工具所有輸入的資料均儲存在「您自己的瀏覽器」中，透過 localStorage 技術自動保存，不需要手動備份<br>
      💡 本工具為純前端運作，您填寫的任何內容「都不會被上傳至伺服器」<br>
      所有資料皆僅存在於您的裝置中，開發者無法存取、查看或備份您所輸入的資料。請放心使用
    </div>    
  </div>

  <div class="floating-clock" id="clock"></div>

  <div class="time-block">
    <div class="time-row">
      <label>開台時間 (Start Time):
        <input type="text" id="startTime" placeholder="HH:MM:SS">
        <button onclick="fillNow('startTime')">現在時間</button>
      </label>
    </div>

    <div class="time-row">
      <label>關台時間 (End Time):
        <input type="text" id="endTime" placeholder="HH:MM:SS">
        <button onclick="fillNow('endTime')">現在時間</button>
      </label>
    </div>

    <div class="time-row">
      <label>直播時長 (Duration):
        <input type="text" id="duration" placeholder="HH:MM:SS">
      </label>
    </div>

    <div style="display: flex; align-items: center; gap: 10px;">
      <label>歌曲清單（歌名 + 時間）</label>
      <label style="font-size:14px; cursor:pointer;">
        <input type="checkbox" id="toggleSuggest">
        啟用歌曲建議
      </label>
    </div>

    <div id="songList"></div>
    <button onclick="addSongRow()">🈳 新增歌曲欄位</button>

    <button onclick="generateTimeline()">✅ 產生直播時間軸</button>
  </div>

  <div class="result-block">
    <h3>📋 結果</h3>
    <textarea class="readonly-output" id="output" readonly></textarea>
  </div>

  <div class="adjust-block">
    <h3>✏️ 校正區</h3>
    <textarea id="adjustArea" placeholder="在這裡貼上並校正時間軸..." style="height:150px;"></textarea>
  </div>

  <div id="clearFixedContainer">
    <button onclick="clearAllData()">🔄 回復成預設</button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="modal" id="confirmModal">
    <p>刪除此欄位會清除其中內容，確定要刪除嗎？</p>
    <label><input type="checkbox" id="noRemind"> 不再提醒</label>
    <div class="modal-footer">
      <div></div>
      <button onclick="confirmDelete()">確認</button>
    </div>
  </div>

  <script>
    const colorOptions = [
      "#f44336", "#e91e63", "#9c27b0", "#3f51b5", "#03a9f4",
      "#009688", "#4caf50", "#ff9800", "#795548", "#607d8b"
    ];

    let timelineSheets = {
      currentSheet: "sheet1",
      sheets: {
        sheet1: {
          name: "工作表 1",
          color: "#f44336",
          data: {
            startTime: "",
            endTime: "",
            duration: "",
            adjustArea: "",
            songs: []
          }
        }
      }
    };

    sessionStorage.removeItem('noRemind');
    let pendingDeleteRow = null;
    let songData = []; 
    let songLoadFailed = false; // 用於檢查 Google Sheets 是否載入失敗

    function showModal(row) {
      const inputs = row.querySelectorAll('input');
      const hasContent = Array.from(inputs).some(input => input.value.trim() !== '');
      const noRemind = sessionStorage.getItem('noRemind') === 'true';

      if (noRemind || !hasContent) {
        row.remove();
        saveAllData();
        return;
      }
      pendingDeleteRow = row;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('confirmModal').style.display = 'block';
    }

    function confirmDelete() {
      if (document.getElementById('noRemind').checked) {
        sessionStorage.setItem('noRemind', 'true');
      }
      if (pendingDeleteRow) {
        pendingDeleteRow.remove();
        saveAllData();
        pendingDeleteRow = null;
      }
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('confirmModal').style.display = 'none';
    }

    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById("clock").textContent = `⏰ ：${h}:${m}:${s}`;
      const delay = 1000 - now.getMilliseconds();
      setTimeout(updateClock, delay);
    }
    updateClock();

    function fillNow(fieldId) {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById(fieldId).value = `${h}:${m}:${s}`;
      saveAllData();
    }

    function fillNowForSong(button) {
      // 往上找到最近一層的 .song-row（整列）
      const row = button.closest('.song-row');
    
      // 在該列中找 placeholder 是「時間 (HH:MM:SS)」的輸入框
      const timeInput = row.querySelector('input[placeholder="時間 (HH:MM:SS)"]');
    
      // 取得現在時間並格式化成 HH:MM:SS
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
    
      // 若成功找到該欄位，填入時間並儲存
      if (timeInput) {
        timeInput.value = `${h}:${m}:${s}`;
        saveAllData(); // 同步儲存
      }
    }

    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    document.getElementById('adjustArea').addEventListener('input', function() {
      autoResizeTextarea(this);
      saveAllData();
    });

    document.getElementById('output').addEventListener('input', function() {
      autoResizeTextarea(this);
      saveAllData();
    });

    function normalizeTimeStr(t) {
      const parts = t.trim().split(":").map(Number);
      while (parts.length < 3) parts.push(0);
      return parts;
    }

    function toSeconds(t) {
      const [h, m, s] = normalizeTimeStr(t);
      return h * 3600 + m * 60 + s;
    }

    function formatSeconds(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // ✅ 將目前畫面資料即時儲存到 timelineSheets 的當前分頁
    function saveAllData() {
      const currentId = timelineSheets.currentSheet;
      const data = timelineSheets.sheets[currentId].data;

      data.startTime = document.getElementById('startTime').value;
      data.endTime = document.getElementById('endTime').value;
      data.duration = document.getElementById('duration').value;
      data.adjustArea = document.getElementById('adjustArea').value;
      data.songs = [];

      document.querySelectorAll('.song-row').forEach(row => {
        const inputs = row.querySelectorAll('input');
        data.songs.push({
          name: inputs[0].value,
          time: inputs[1].value
        });
      });

      localStorage.setItem('timelineSheets', JSON.stringify(timelineSheets));
    }

    // ✅ 將 timelineSheets 的當前分頁資料還原至畫面欄位
    function restoreSheetData() {
      const currentId = timelineSheets.currentSheet;
      const data = timelineSheets.sheets[currentId].data;

      document.getElementById('startTime').value = data.startTime || '';
      document.getElementById('endTime').value = data.endTime || '';
      document.getElementById('duration').value = data.duration || '';
      document.getElementById('adjustArea').value = data.adjustArea || '';
      autoResizeTextarea(document.getElementById('adjustArea'));

      const container = document.getElementById('songList');
      container.innerHTML = '';

      // ✅ 若該分頁完全沒歌曲 → 預設產出 5 個空白欄位
      const songs = (data.songs && data.songs.length > 0) ? data.songs : Array(5).fill({ name: '', time: '' });
      songs.forEach(song => addSongRow(song.name, song.time));
    }


    // 清空資料
    function clearAllData() {
      if (confirm('確定要清空所有工作表，回復為預設狀態？')) {
        // 移除 timelineSheets 資料
        localStorage.removeItem('timelineSheets');

        // 如果還殘留舊資料也順便刪掉
        localStorage.removeItem('timelineData');

        // 重新載入頁面，會自動建立預設工作表
        location.reload();
      }
    }

    function renderSheetTabs() {
      const container = document.getElementById("sheetTabsContainer");

      // 🔁 只刪掉舊的工作表按鈕（.sheet-tab-btn），保留新增按鈕
      const oldButtons = container.querySelectorAll('.sheet-tab-btn-wrapper');
      oldButtons.forEach(btn => btn.remove());

      Object.entries(timelineSheets.sheets).forEach(([sheetId, sheet]) => {
        // 包裝整個分頁按鈕 + ⋯ 的 wrapper
        const wrapper = document.createElement("div");
        wrapper.className = "sheet-tab-btn-wrapper";
        wrapper.style.position = "relative";
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";

        // 🔘 分頁按鈕
        const btn = document.createElement("button");
        btn.className = "sheet-tab-btn";
        if (sheetId === timelineSheets.currentSheet) {
          btn.classList.add("active");
        }
        btn.textContent = sheet.name;
        btn.style.backgroundColor = sheet.color;
        btn.style.flex = "1";
        btn.onclick = () => {
          saveAllData();
          timelineSheets.currentSheet = sheetId;
          localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
          renderSheetTabs();
          restoreSheetData();
        };

        // ⋯ 按鈕
        const moreBtn = document.createElement("div");
        moreBtn.textContent = "⋯";
        moreBtn.className = "sheet-tab-menu";
        moreBtn.onclick = (e) => {
          e.stopPropagation();
          showSheetMenu(sheetId, moreBtn);
        };

        wrapper.appendChild(btn);
        wrapper.appendChild(moreBtn);
        container.appendChild(wrapper);
      });
    }

    function createNewSheet() {
      // 找出未使用的顏色
      const usedColors = Object.values(timelineSheets.sheets).map(sheet => sheet.color);
      let availableColors = colorOptions.filter(color => !usedColors.includes(color));
      if (availableColors.length === 0) {
        availableColors = [...colorOptions]; // 全部用過就重置
      }

      // 隨機挑一個顏色
      const color = availableColors[Math.floor(Math.random() * availableColors.length)];

      // 自動命名：「工作表 n」
      const existingNames = Object.values(timelineSheets.sheets).map(s => s.name);
      let index = 1;
      let newName;
      do {
        newName = `工作表 ${index++}`;
      } while (existingNames.includes(newName));

      // 自動產生新 ID（如 sheet3、sheet4）
      let idCounter = 1;
      let newId;
      do {
        newId = `sheet${++idCounter}`;
      } while (timelineSheets.sheets[newId]);

      // 新增資料
      timelineSheets.sheets[newId] = {
        name: newName,
        color: color,
        data: {
          startTime: "",
          endTime: "",
          duration: "",
          adjustArea: "",
          songs: []
        }
      };

      timelineSheets.currentSheet = newId;
      localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
      renderSheetTabs();
      restoreSheetData();
    }

    function showSheetMenu(sheetId, anchorElement) {
      // 先清除舊的 popup（若存在）
      document.querySelectorAll(".sheet-menu-popup").forEach(el => el.remove());

      const menu = document.createElement("div");
      menu.className = "sheet-menu-popup";

      // ✏️ 重新命名
      const renameItem = document.createElement("div");
      renameItem.textContent = "✏️ 重新命名";
      renameItem.onclick = () => {
        const newName = prompt("請輸入新的工作表名稱：", timelineSheets.sheets[sheetId].name);
        if (newName && newName.trim()) {
          timelineSheets.sheets[sheetId].name = newName.trim();
          localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
          renderSheetTabs();
        }
        menu.remove();
      };
      menu.appendChild(renameItem);

      // 🗑️ 刪除分頁
      const deleteItem = document.createElement("div");
      deleteItem.textContent = "🗑️ 刪除工作表";
      deleteItem.onclick = () => {
        const sheetCount = Object.keys(timelineSheets.sheets).length;
        if (sheetCount <= 1) {
          alert("至少需要保留一個工作表！");
          return;
        }

        if (confirm(`確定要刪除「${timelineSheets.sheets[sheetId].name}」嗎？\n這個工作表的所有資料將一併刪除。`)) {
          delete timelineSheets.sheets[sheetId];

          // 若刪除的是當前分頁，切換到其他任一個
          if (timelineSheets.currentSheet === sheetId) {
            timelineSheets.currentSheet = Object.keys(timelineSheets.sheets)[0];
          }

          localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
          renderSheetTabs();
          restoreSheetData();
        }

        menu.remove();
      };
      menu.appendChild(deleteItem);

      // 插入選單
      anchorElement.parentElement.appendChild(menu);

      // 點其他地方就關閉選單
      setTimeout(() => {
        window.addEventListener("click", () => menu.remove(), { once: true });
      }, 0);
    }

    function addSongRow(name = '', time = '') {
      const container = document.getElementById("songList");
      const row = document.createElement("div");
      row.className = "song-row";
      
      // --- 請將 row.innerHTML 完全替換成以下版本 ---
      row.innerHTML = `
        <button onclick="showModal(this.parentElement)">刪除</button>

        <div style="position: relative; flex: 1;">
          <input 
            type="text" 
            placeholder="歌名" 
            value="${name}" 
            oninput="saveAllData(); showSuggestions(this);" 
            onblur="setTimeout(() => { this.nextElementSibling.classList.add('hidden'); }, 150)"
            style="width: 100%;">
          <ul class="suggest-list hidden"></ul>
        </div>

        <div style="flex: 1;">
          <input 
            type="text" 
            placeholder="時間 (HH:MM:SS)" 
            value="${time}" 
            oninput="saveAllData()"
            style="width: 100%;">
        </div>

        <button onclick="fillNowForSong(this)">現在時間</button>
      `;
      container.appendChild(row);
    }

    loadSongs(); // 讀取 Google Sheets 資料

    // 綁定 startTime / endTime / duration
    ['startTime', 'endTime', 'duration'].forEach(id => {
      document.getElementById(id).addEventListener('input', saveAllData);
    });

    function generateTimeline() {
      let startTime = document.getElementById("startTime").value.trim();
      const endTime = document.getElementById("endTime").value.trim();
      const duration = document.getElementById("duration").value.trim();

      if (!startTime && endTime && duration) {
        let endSec = toSeconds(endTime);
        let durSec = toSeconds(duration);
        let startSec = endSec - durSec;
        if (startSec < 0) startSec += 86400;
        startTime = formatSeconds(startSec);
      }

      if (!startTime) {
        alert("請輸入開台時間或提供結束時間與時長。");
        return;
      }

      const startSec = toSeconds(startTime);
      let result = [];

      const rows = document.querySelectorAll(".song-row");
      for (const row of rows) {
        const inputs = row.querySelectorAll("input");
        const name = inputs[0].value.trim();
        const absTime = inputs[1].value.trim();
        if (!name || !absTime) continue;
        let songSec = toSeconds(absTime);
        let diff = songSec - startSec;
        if (diff < 0) diff += 86400; // 跨日處理
        result.push({ time: diff, text: `${formatSeconds(diff)} ${name}` });
      }

      result.sort((a, b) => a.time - b.time);
      const outputEl = document.getElementById("output");
      outputEl.value = result.map(r => r.text).join("\n");
      autoResizeTextarea(outputEl);
      saveAllData();
    }

    // 從 Google Sheets 載入資料
    function loadSongs() {
      const url = 'https://docs.google.com/spreadsheets/d/1fWMyrdJroo2bWngbxvdfLP6ohfGO87dSirEWbKzMVRE/export?format=csv'; // 改成你的公開CSV連結
      fetch(url)
        .then(response => response.text())
        .then(data => {
          songData = data.split('\n').slice(1).map(line => {
            const [title, artist] = line.split(',');
            return `${title.trim()}（${artist ? artist.trim() : ''}）`;
          });
          songLoadFailed = false;
        })
        .catch(err => {
          songLoadFailed = true;
          console.error('Google Sheets 載入失敗:', err);
        });
    }

    // 啟用建議開關時檢查載入狀態
    document.getElementById('toggleSuggest').addEventListener('change', function() {
      if (this.checked && songLoadFailed) {
        alert('⚠️ 歌曲建議載入失敗！\n請檢查你的網路連線或稍後再試。');
      }
    });

    // 顯示建議
    function showSuggestions(input) {
      const list = input.nextElementSibling;
      if (!list || !list.classList.contains('suggest-list')) return;

      list.innerHTML = '';
      const query = input.value.trim().toLowerCase();

      if (!query || document.getElementById('toggleSuggest')?.checked === false) {
        list.classList.add('hidden');
        return;
      }

      const filtered = songData.filter(item => item.toLowerCase().includes(query));

      if (filtered.length === 0) {
        list.classList.add('hidden');
        return;
      }
      
      // 顯示所有符合的建議 (已移除 .slice(0, 5))
      filtered.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        li.onclick = () => {
          input.value = item;
          list.classList.add('hidden');
          saveAllData();
        };
        list.appendChild(li);
      });

      list.classList.remove('hidden');
    }

    initSheets(); // ← 頁面載入時執行

    function initSheets() {
      const saved = localStorage.getItem("timelineSheets");
      if (saved) {
        timelineSheets = JSON.parse(saved);
      } else {
        localStorage.setItem("timelineSheets", JSON.stringify(timelineSheets));
      }

      renderSheetTabs();
      restoreSheetData(); // 這個 function 之後會改為讀取「目前分頁」的資料
    }
  </script>
</body>
</html>
